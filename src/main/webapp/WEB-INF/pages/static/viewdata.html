<!DOCTYPE html>

<html lang="ru">
<head>

    <script type="text/ecmascript" src=trirand/js/jquery-1.11.0.min.js></script>
    <!-- The jQuery library is a prerequisite for all jqSuite products -->
    <!-- We support more than 40 localizations -->
    <script type="text/ecmascript" src="trirand/js/i18n/grid.locale-ru.js"></script>
    <!-- This is the Javascript file of jqGrid -->
    <!--<script type="text/ecmascript" src="trirand/js/jquery.jqGrid.min.js"></script>-->
    <!-- This is the localization file of the grid controlling messages, labels, etc.
    <!-- A link to a jQuery UI ThemeRoller theme, more than 22 built-in and many more custom -->
    <script type="text/ecmascript" src="trirand/js/jquery.jqGrid.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="trirand/css/ui.jqgrid-bootstrap.css">
    <!--<link rel="stylesheet" type="text/css" media="screen" href="trirand/css/ui.jqgrid-bootstrap-ui.css">-->
    <!-- The link to the CSS that the grid needs -->

    <script>
        $.jgrid.defaults.width = 780;
        $.jgrid.defaults.styleUI = 'Bootstrap';
        $.jgrid.defaults.responsive = true;
    </script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.1/bootstrap3-typeahead.min.js"></script>

    <meta charset="utf-8"/>
    <title>Данные адресной книги</title>
</head>
<body>

<div style="margin-left:20px">
    <table id="jqGrid"></table>
    <div id="jqGridPager"></div>
</div>

<script type="text/javascript">


    $(document).ready(function () {
        userLogin = localStorage.getItem('userLogin');
        token = localStorage.getItem('token');
        $("#jqGrid").jqGrid({
            url: '/getEntries',
            datatype: "json",
            mtype: 'POST',
            postData: {userLogin: userLogin, token: token},
            loadError: function LoadErrorHandler(jqXHR, textStatus, errorThrown){
                alert("Ошибка авторизации. Вы будете перенаправлены на страницу ввода.");
                window.location.replace("login.html");
            },
            colModel: [
                {
                    label: 'Фамилия',
                    name: 'lastName',
                    editable: true,
                    editrules: {custom: true, custom_func: isValidName},
                    required: true,
                    width: 75,
                    sorttype: 'String',
                    searchoptions: {
                        dataInit: function (element) {
                            $(element).attr("autocomplete", "on").typeahead({
                                appendTo: "body",
                                source: function (query, proxy) {
                                    $.ajax({
                                        url: '/search',
                                        dataType: "jsonp",
                                        data: {term: query, columnName: 'LastName', userLogin : userLogin, token : token},
                                        success: proxy,
                                        method: 'POST'
                                    });
                                }
                            });
                        },
                        sopt: ['cn']
                    }
                },
                {
                    label: 'Имя', name: 'firstName',
                    editable: true,
                    editrules: {custom: true, custom_func: isValidName},
                    required: true,
                    width: 90,
                    sorttype: 'String',
                    searchoptions: {
                        dataInit: function (element) {
                            $(element).attr("autocomplete", "off").typeahead({
                                appendTo: "body",
                                source: function (query, proxy) {
                                    $.ajax({
                                        url: '/search',
                                        dataType: "jsonp",
                                        data: {term: query, columnName: 'FirstName', userLogin : userLogin, token : token},
                                        success: proxy,
                                        method: 'POST'
                                    });
                                }
                            });
                        },
                        sopt: ['cn']
                    }
                },
                {
                    label: 'Отчество', name: 'patronymic',
                    editable: true,
                    editrules: {custom: true, custom_func: isValidName},
                    required: true,
                    width: 100,
                    sorttype: 'String',
                    search: true,
                    searchoptions: {
                        dataInit: function (element) {
                            $(element).attr("autocomplete", "off").typeahead({
                                appendTo: "body",
                                source: function (query, proxy) {
                                    $.ajax({
                                        url: '/search',
                                        dataType: "json",
                                        data: {term: query, columnName: 'Patronymic', userLogin : userLogin, token : token},
                                        success: proxy,
                                        method: 'POST'
                                    });
                                }
                            });
                        },
                        sopt: ['cn']
                    }
                },
                {
                    label: 'Мобильный тел.', name: 'cellNumber',
                    editable: true,
                    editrules: {custom: true, custom_func: isValidPhone},
                    required: true,
                    width: 80,
                    sorttype: 'String',
                    key: true,
                    searchoptions: {
                        dataInit: function (element) {
                            $(element).attr("autocomplete", "off").typeahead({
                                appendTo: "body",
                                source: function (query, proxy) {
                                    $.ajax({
                                        url: '/search',
                                        dataType: "jsonp",
                                        data: {term: query, columnName: 'CellNumber', userLogin : userLogin, token : token},
                                        success: proxy,
                                        method: 'POST'
                                    });
                                }
                            });
                        },
                        sopt: ['cn']
                    }
                },
                {
                    label: 'Домашний тел.', name: 'phoneNumber',
                    editable: true,
                    editrules: {custom: true, custom_func: isValidPhone},
                    width: 80,
                    required: false,
                    sorttype: 'String',
                    sortType: 'String',
                    searchoptions: {
                        dataInit: function (element) {
                            $(element).attr("autocomplete", "off").typeahead({
                                appendTo: "body",
                                source: function (query, proxy) {
                                    $.ajax({
                                        url: '/search',
                                        dataType: "jsonp",
                                        data: {term: query, columnName: 'PhoneNumber', userLogin : userLogin, token : token},
                                        success: proxy,
                                        method: 'POST'
                                    });
                                }
                            });
                        },
                        sopt: ['cn']
                    }
                },
                {
                    label: 'Адрес', name: 'address', width: 80,
                    editable: true,
                    required: false,
                    sorttype: 'String',
                    sortType: 'String',
                    searchoptions: {
                        dataInit: function (element) {
                            $(element).attr("autocomplete", "off").typeahead({
                                appendTo: "body",
                                source: function (query, proxy) {
                                    $.ajax({
                                        url: '/search',
                                        dataType: "jsonp",
                                        data: {term: query, columnName: 'Address', userLogin : userLogin, token : token},
                                        success: proxy,
                                        method: 'POST'
                                    });
                                }
                            });
                        },
                        sopt: ['cn']
                    }
                },
                {
                    label: 'Е-почта', name: 'email', width: 80,
                    editable: true,
                    required: false,
                    editrules: {email: true, required: false},
                    sorttype: 'String',
                    sortType: 'String',
                    searchoptions: {
                        dataInit: function (element) {
                            $(element).attr("autocomplete", "off").typeahead({
                                appendTo: "body",
                                source: function (query, proxy) {
                                    $.ajax({
                                        url: '/search',
                                        dataType: "jsonp",
                                        data: {term: query, columnName: 'Email', userLogin : userLogin, token : token},
                                        success: proxy,
                                        method: 'POST'
                                    });
                                }
                            });
                        },
                        sopt: ['cn']
                    }
                }
            ],
            viewrecords: true, // show the current page, data rang and total records on the toolbar
            width: 780,
            height: 200,
            rowNum: 4,
            loadonce: false,
            pager: "#jqGridPager"
        });

        function isValidName(value, column) {
            if (!/[^a-zа-я]/i.test(value) == true && value.length >= 4)
                return [true, ""];
            else
                return [false, "Ошибка ввода. Проверьте правильность заполнения формы"];
        }

        function isValidPhone(value, column) {
            var str = value.replace(/(\s|\(|\)|-|\.|\+)/g, '');
            if (str.length == 0)
                return [true, ''];
            else
            if ((str.length == 10 || str.length == 12) && /^\d+$/.test(str))
                return [true, ''];
            else
                return [false, "Ошибка ввода телефонного номера. Проверьте правильность заполнения формы!"];
        }

        $('#jqGrid').jqGrid('filterToolbar');
        $('#jqGrid').jqGrid('navGrid',"#jqGridPager",
                // the buttons to appear on the toolbar of the grid
                {
                    edit: true,
                    add: true,
                    del: true,
                    search: false,
                    refresh: true,
                    view: true,
                    position: "left",
                    cloneToTop: false
                },
                {
                    editData: {userLogin: userLogin, token: token},
                    url: '/editEntry'
                },
                {
                    editData: {userLogin: userLogin, token: token},
                    url: '/addEntry'
                },
                {
                    delData: {userLogin: userLogin, token: token},
                    url: '/deleteEntry'
                },
                // options for the Edit Dialog
                {
                    height: 'auto',
                    width: 620,
                    editCaption: "The Edit Dialog",
                    recreateForm: true,
                    closeAfterEdit: true,
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                },
                // options for the Add Dialog
                {
                    height: 'auto',
                    width: 620,
                    closeAfterAdd: true,
                    recreateForm: true,
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                },
                // options for the Delete Dialog
                {
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                });
    });
</script>

</body>
</html>